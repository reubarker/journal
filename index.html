<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Journal Viewer (Read-only)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  /* THEME TOKENS */
  :root {
    --bg:#0b0d10; --panel:#14181d; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa;
    --border:#1f2937; --card:#0b1220; --cardHover:#0f1626; --chip:#0f172a; --thumbBg:#0b0d10;
    --good:#1f3a8a;
  }
  body.light {
    --bg:#f6f7f9; --panel:#ffffff; --muted:#6b7280; --text:#111827; --accent:#2563eb;
    --border:#e5e7eb; --card:#ffffff; --cardHover:#f3f4f6; --chip:#f3f4f6; --thumbBg:#f3f4f6;
    --good:#dbeafe;
  }

  /* BASE */
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Arial}

  header{
    display:flex;gap:.5rem;align-items:center;justify-content:space-between;
    padding:10px 12px;border-bottom:1px solid var(--border);background:var(--panel);
    position:sticky;top:0;z-index:5
  }
  header .actions{display:flex;gap:.5rem;flex-wrap:wrap}
  button, select{
    background:var(--chip);color:var(--text);border:1px solid var(--border);
    border-radius:8px;padding:.5rem .75rem;cursor:pointer
  }
  button:hover{border-color:#334155}
  .tint{color:var(--muted);font-size:12px;margin-left:.5rem}

  main{display:grid;grid-template-columns:40% 60%;height:calc(100vh - 56px)}

  /* SIDEBAR */
  aside{border-right:1px solid var(--border);overflow:auto;background:var(--panel)}
  .toolbar{display:flex;gap:.5rem;padding:10px;border-bottom:1px solid var(--border);
    position:sticky;top:0;background:var(--panel);z-index:4;align-items:center;justify-content:space-between}
  .list{padding:8px}
  .card{
    display:grid;grid-template-columns:64px 1fr;gap:10px;align-items:start;
    padding:8px;border-radius:10px;border:1px solid var(--border);background:var(--card);
    margin-bottom:8px;cursor:pointer
  }
  .card:hover{background:var(--cardHover)}
  .thumb{width:64px;height:64px;border-radius:8px;object-fit:cover;background:var(--thumbBg);border:1px solid var(--border)}
  .meta{display:flex;flex-direction:column;gap:2px}
  .filename{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .preview{
    color:var(--muted);font-size:12px;margin-top:4px;max-height:1.3em;overflow:hidden;
    display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical
  }

  /* READER */
  article{overflow:auto;padding:16px}
  .reader-title{font-size:1.4rem;font-weight:600;margin-bottom:1rem;color:var(--text);word-break:break-word}
  .metadata-box{
    background:var(--chip);border:1px solid var(--border);border-radius:8px;
    padding:10px 12px;margin-bottom:20px;font-size:13px
  }
  .meta-row{display:flex;gap:6px;border-bottom:1px solid var(--border);padding:3px 0}
  .meta-row:last-child{border-bottom:none}
  .meta-key{color:var(--muted);min-width:80px;font-weight:600;text-transform:capitalize}
  .meta-val{color:var(--text);flex:1;word-break:break-word}
  .md{max-width:900px;margin:0 auto}
  .md h1,.md h2,.md h3{margin-top:1.2em}
  .md img{max-width:100%;border-radius:10px;border:1px solid var(--border)}
  .empty{opacity:.8;color:var(--muted);text-align:center;margin-top:20vh}

  /* GALLERY */
  .gallery{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0 8px 0}
  .g-thumb{width:72px;height:72px;border:1px solid var(--border);border-radius:8px;object-fit:cover;cursor:pointer}
  .g-thumb.selected{outline:2px solid var(--accent)}
  .hero{display:block;max-width:100%;max-height:60vh;border:1px solid var(--border);border-radius:10px;margin:18px 0;cursor:pointer}

  /* LIGHTBOX */
  .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:50}
  .lightbox.open{display:flex}
  .lightbox img{max-width:90vw;max-height:90vh;border-radius:10px;background:#000}
  .lb-controls{position:fixed;bottom:24px;display:flex;gap:8px}
  .lb-btn{background:#111827;color:#fff;border:1px solid #374151;border-radius:8px;padding:.5rem .75rem;cursor:pointer}

  /* MONTH GRID — UPDATED FOR IMAGE FILL */
  .month-wrap{padding:10px 10px 0 10px;border-bottom:1px dashed var(--border)}
  .month-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;color:var(--muted);font-size:12px}
  .month-grid{
    display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:8px
  }
  .weekday{color:var(--muted);font-size:11px;text-align:center;margin-bottom:6px}

  .day {
    position: relative;
    border: 1px dashed var(--border);
    border-radius: 8px;
    min-height: 60px;
    padding: 4px 6px;
    display: flex;
    align-items: flex-start;
    justify-content: flex-end;
    overflow: hidden;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  .day.has-img::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom right, rgba(0,0,0,.15), rgba(0,0,0,.4));
  }
  .day-num {
    position: relative;
    z-index: 2;
    font-size: 12px;
    font-weight: 600;
    text-shadow: 0 1px 3px rgba(0,0,0,.8);
    color: #fff;
  }

  .hidden{visibility:hidden}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
<header>
  <div class="actions">
    <button id="pickJournal">Select Journal Root</button>
    <button id="pickImages">Select Images Root</button>
    <span class="tint">\01-Journal\YYYY\MM • \Images\YYYY\YYYYMMDD(-NN).jpg|png|gif</span>
  </div>
  <div class="actions">
    <select id="yearSelect" disabled></select>
    <select id="monthSelect" disabled></select>
    <button id="themeToggle" title="Toggle theme">Theme</button>
  </div>
</header>

<main>
  <aside>
    <div class="toolbar">
      <span>Entries</span>
      <span id="status" class="tint"></span>
    </div>

    <!-- MONTH GRID -->
    <div id="monthWrap" class="month-wrap" hidden>
      <div class="month-title">
        <div id="monthLabel">Month YYYY</div>
        <div class="tint">Click a day to open (if a file exists)</div>
      </div>
      <div class="month-grid" id="monthGrid"></div>
    </div>

    <div id="entries" class="list"></div>
  </aside>
  <article>
    <div id="reader" class="md">
      <div class="empty">Pick folders, then select a date.</div>
    </div>
  </article>
</main>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" aria-hidden="true">
  <img id="lbImg" alt="image" />
  <div class="lb-controls">
    <button class="lb-btn" id="lbPrev">Prev</button>
    <button class="lb-btn" id="lbNext">Next</button>
    <button class="lb-btn" id="lbClose">Close</button>
  </div>
</div>

<script type="module">
/* — Util, Theme, Storage, Indexer unchanged — */

/* CALENDAR UPDATE — ONLY THIS PART CHANGED */
async function renderCalendarImages(cell, entry) {
  try {
    if (State.imagesRoot) {
      const yDir = await State.imagesRoot.getDirectoryHandle(entry.year, { create:false });
      const imgs = await FS.enumerateAllImages(yDir, entry.date);
      if (imgs.length) {
        cell.style.backgroundImage = `url("${imgs[0].url}")`;
        cell.classList.add('has-img');
      }
    }
  } catch {}
}

/* Modify Calendar.render() */
Calendar.render = async function(year, month) {
  const items = State.index[year]?.[month] || [];
  wrap.hidden = false;
  clear();

  label.textContent = new Date(`${year}-${month}-01`)
    .toLocaleDateString(undefined,{month:'long',year:'numeric'})
    .toUpperCase();

  const header = document.createDocumentFragment();
  weekdays.forEach(w=>{
    const h=document.createElement('div');
    h.className='weekday';
    h.textContent=w;
    header.appendChild(h);
  });
  grid.appendChild(header);

  const firstDow=new Date(`${year}-${month}-01`).getDay();
  const days=Utils.daysInMonth(Number(year),Number(month));

  for(let i=0;i<firstDow;i++) grid.appendChild(document.createElement('div'));

  const map=new Map();
  items.forEach(e=>map.set(e.date.slice(6,8),e));

  for(let d=1;d<=days;d++){
    const dd=Utils.pad(d);
    const cell=document.createElement('div');
    cell.className='day';

    const num=document.createElement('div');
    num.className='day-num';
    num.textContent=d;
    cell.appendChild(num);

    const entry=map.get(dd);
    if(entry){
      cell.classList.add('has-file');
      cell.addEventListener('click',()=>UI.openEntry(entry));
      renderCalendarImages(cell, entry); // ✅ NEW VERSION
    }
    grid.appendChild(cell);
  }
}

/* — Rest of script unchanged — */
</script>
</body>
</html>
